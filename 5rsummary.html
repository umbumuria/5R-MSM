<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>5R Commander Pro Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .glass-card { background: white; border-radius: 1.5rem; border: 1px solid rgba(226, 232, 240, 0.8); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05); }
        .filter-select { background-color: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 0.75rem; padding: 0.6rem 1rem; font-size: 0.85rem; font-weight: 600; color: #475569; outline: none; transition: all 0.2s; min-width: 160px; }
        .filter-select:focus { border-color: #10b981; background-color: #fff; ring: 2px solid #10b981; }
        .stat-value { font-size: 2.5rem; font-weight: 800; line-height: 1; margin-bottom: 0.5rem; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">

    <nav class="bg-white border-b border-slate-200 px-8 py-4 sticky top-0 z-50">
        <div class="max-w-[1600px] mx-auto flex flex-col lg:flex-row justify-between items-center gap-6">
            <div class="flex items-center gap-4">
                <div class="bg-emerald-500 text-white w-12 h-12 rounded-2xl flex items-center justify-center font-black text-xl shadow-lg shadow-emerald-200">5R</div>
                <div>
                    <h1 class="text-xl font-extrabold tracking-tight text-slate-800">SUMMARY AUDIT 5R + 2S</h1>
                    <p class="text-[10px] font-bold text-slate-400 tracking-widest uppercase">Operational Performance Dashboard</p>
                </div>
            </div>

            <div class="flex flex-wrap gap-3 justify-center">
                <select id="f-group" onchange="applyFilters()" class="filter-select"></select>
                <select id="f-lokasi" onchange="applyFilters()" class="filter-box filter-select"></select>
                <select id="f-auditor" onchange="applyFilters()" class="filter-select"></select>
                <select id="f-bulan" onchange="applyFilters()" class="filter-select"></select>
                <select id="f-tahun" onchange="applyFilters()" class="filter-select"></select>
            </div>
        </div>
    </nav>

    <main class="max-w-[1600px] mx-auto p-8">
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
            <div class="glass-card p-6 border-l-[6px] border-amber-500">
                <p class="text-xs font-bold text-slate-400 uppercase mb-2">Avg 5R Score</p>
                <div class="flex items-center gap-4">
                    <span id="stat-5r" class="stat-value text-slate-800">0</span>
                    <span class="text-xs font-bold bg-amber-100 text-amber-700 px-2 py-1 rounded">vs Target 95</span>
                </div>
            </div>
            <div class="glass-card p-6 border-l-[6px] border-red-500">
                <p class="text-xs font-bold text-slate-400 uppercase mb-2">Avg Safety Score</p>
                <div class="flex items-center gap-4">
                    <span id="stat-s1" class="stat-value text-slate-800">0</span>
                    <span class="text-xs font-bold bg-red-100 text-red-700 px-2 py-1 rounded">S1 Compliance</span>
                </div>
            </div>
            <div class="glass-card p-6 border-l-[6px] border-blue-500">
                <p class="text-xs font-bold text-slate-400 uppercase mb-2">Avg Energy Score</p>
                <div class="flex items-center gap-4">
                    <span id="stat-s2" class="stat-value text-slate-800">0</span>
                    <span class="text-xs font-bold bg-blue-100 text-blue-700 px-2 py-1 rounded">S2 Efficiency</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
            <div class="glass-card p-8">
                <div class="flex justify-between items-center mb-8">
                    <h3 class="font-extrabold text-slate-700 uppercase text-xs tracking-wider">5R Score vs Target</h3>
                </div>
                <div class="h-[350px]"><canvas id="chart5R"></canvas></div>
            </div>

            <div class="glass-card p-8">
                <div class="flex justify-between items-center mb-8">
                    <h3 class="font-extrabold text-slate-700 uppercase text-xs tracking-wider">Safety Performance (S1)</h3>
                </div>
                <div class="h-[350px]"><canvas id="chartSafety"></canvas></div>
            </div>

            <div class="glass-card p-8">
                <div class="flex justify-between items-center mb-8">
                    <h3 class="font-extrabold text-slate-700 uppercase text-xs tracking-wider">Energy Saving (S2)</h3>
                </div>
                <div class="h-[350px]"><canvas id="chartEnergy"></canvas></div>
            </div>
        </div>
    </main>

    <script>
        const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT88wHMtZWXtIH3qMCZkLm8S7gDYV6n42v8AHrF6YRpoIMsixdG4EfTiUKe2ERQ7HuAShHSW_mvTg4T/pub?output=csv';
        let rawData = [], colMap = {}, charts = {};

        Papa.parse(csvUrl, {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                const headers = results.meta.fields;
                const find = (keys) => headers.find(h => keys.some(k => h.trim().toUpperCase() === k.toUpperCase()));

                colMap = {
                    group: find(['GROUP']),
                    lokasi: find(['LOKASI', 'AREA']),
                    auditor: find(['AUDITOR']),
                    bulan: find(['BULAN']),
                    tahun: find(['YEAR', 'TAHUN']),
                    score5r: find(['5R']),
                    s1: find(['S1']),
                    s2: find(['S2'])
                };

                rawData = results.data.filter(d => d[colMap.group] && d[colMap.score5r]);
                populateFilters(rawData);
                applyFilters();
            }
        });

        function populateFilters(data) {
            const fill = (id, key, label) => {
                const s = document.getElementById(id);
                const vals = [...new Set(data.map(d => d[key]?.trim()))].filter(v => v).sort();
                s.innerHTML = `<option value="">SEMUA ${label}</option>`;
                vals.forEach(v => s.innerHTML += `<option value="${v}">${v}</option>`);
            };
            fill('f-group', colMap.group, 'GROUP');
            fill('f-lokasi', colMap.lokasi, 'LOKASI');
            fill('f-auditor', colMap.auditor, 'AUDITOR');
            fill('f-bulan', colMap.bulan, 'BULAN');
            fill('f-tahun', colMap.tahun, 'TAHUN');
        }

        function applyFilters() {
            const fG = document.getElementById('f-group').value;
            const fL = document.getElementById('f-lokasi').value;
            const fA = document.getElementById('f-auditor').value;
            const fB = document.getElementById('f-bulan').value;
            const fT = document.getElementById('f-tahun').value;

            const filtered = rawData.filter(d => 
                (!fG || d[colMap.group]?.trim() === fG) && 
                (!fL || d[colMap.lokasi]?.trim() === fL) && 
                (!fA || d[colMap.auditor]?.trim() === fA) && 
                (!fB || d[colMap.bulan]?.trim() === fB) && 
                (!fT || d[colMap.tahun]?.trim() === fT)
            );

            updateDashboard(filtered);
        }

        function updateDashboard(data) {
            const uniqueGroups = [...new Set(data.map(d => d[colMap.group].trim()))].sort();
            
            const getAvg = (groupName, key) => {
                const subset = data.filter(d => d[colMap.group].trim() === groupName);
                if (subset.length === 0) return 0;
                const total = subset.reduce((s, r) => s + (parseFloat(r[key]) || 0), 0);
                return Math.round(total / subset.length);
            };

            const data5R = uniqueGroups.map(g => getAvg(g, colMap.score5r));
            const dataS1 = uniqueGroups.map(g => getAvg(g, colMap.s1));
            const dataS2 = uniqueGroups.map(g => getAvg(g, colMap.s2));
            const dataTarget = uniqueGroups.map(() => 95);

            // Update Summary Text
            const calcTotalAvg = (dataset) => dataset.length ? Math.round(dataset.reduce((a,b)=>a+b,0)/dataset.length) : 0;
            document.getElementById('stat-5r').innerText = calcTotalAvg(data5R);
            document.getElementById('stat-s1').innerText = calcTotalAvg(dataS1);
            document.getElementById('stat-s2').innerText = calcTotalAvg(dataS2);

            // Render Charts with custom styles
            renderChart('chart5R', uniqueGroups, [
                { label: 'ACTUAL', data: data5R, backgroundColor: '#f59e0b', borderRadius: 8 },
                { label: 'TARGET', data: dataTarget, backgroundColor: '#22d3ee', borderRadius: 8 }
            ]);
            renderChart('chartSafety', uniqueGroups, [{ label: 'S1', data: dataS1, backgroundColor: '#ef4444', borderRadius: 12 }]);
            renderChart('chartEnergy', uniqueGroups, [{ label: 'S2', data: dataS2, backgroundColor: '#3b82f6', borderRadius: 12 }]);
        }

        function renderChart(id, labels, datasets) {
            if(charts[id]) charts[id].destroy();
            charts[id] = new Chart(document.getElementById(id), {
                type: 'bar',
                data: { labels, datasets },
                options: {
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, max: 100, grid: { borderDash: [5, 5], color: '#e2e8f0' }, ticks: { font: { size: 11, weight: '600' }, color: '#94a3b8' } },
                        x: { grid: { display: false }, ticks: { font: { size: 12, weight: '700' }, color: '#475569' } }
                    },
                    animation: { duration: 1500, easing: 'easeOutQuart' }
                },
                plugins: [{
                    afterDatasetsDraw(chart) {
                        const {ctx} = chart;
                        chart.data.datasets.forEach((dataset, i) => {
                            chart.getDatasetMeta(i).data.forEach((bar, index) => {
                                const val = dataset.data[index];
                                ctx.fillStyle = i === 1 ? '#0891b2' : '#fff';
                                ctx.font = 'bold 12px sans-serif';
                                ctx.textAlign = 'center';
                                if(val > 0) ctx.fillText(val, bar.x, bar.y + 20);
                            });
                        });
                    }
                }]
            });
        }
    </script>
</body>
</html>
